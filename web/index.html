<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reverie</title>
    <link rel="stylesheet" href="style.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600&display=swap" rel="stylesheet">
</head>

<body>
    <div id="app">
        <!-- Background Layer -->
        <div id="background-layer"></div>

        <!-- Main Container -->
        <div class="container">
            <!-- Header -->
            <header>
                <img src="logo.png" alt="Logo" class="logo-img">
                <div class="controls">
                    <button id="sessions-btn" class="icon-btn" title="Browse Sessions">üìÇ</button>
                    <button id="export-btn" class="icon-btn" title="Export Gallery">üì•</button>
                    <button id="settings-btn" class="icon-btn">‚öôÔ∏è</button>
                </div>
            </header>

            <!-- Chat Area -->
            <div id="chat-container">
                <div id="messages">
                    <!-- Messages will be injected here -->
                    <div class="message system">
                        <div class="content">Initializing connection...</div>
                    </div>
                </div>
            </div>

            <!-- Scene Queue Panel -->
            <div id="scene-queue-panel" class="scene-queue-panel hidden">
                <div class="scene-queue-header" onclick="toggleSceneQueuePanel()">
                    <span>üé¨ Story Queue <span id="scene-count-badge" class="count-badge">0</span></span>
                    <span class="toggle-arrow">‚ñº</span>
                </div>
                <div class="scene-queue-content">
                    <div id="scene-queue-container" class="scene-queue-container">
                        <!-- Scene cards will be injected here -->
                    </div>
                    <div class="scene-queue-actions">
                        <button id="compile-story-btn" class="compile-btn" disabled>üé• Compile Story</button>
                        <button id="clear-queue-btn" class="clear-btn">üóëÔ∏è Clear</button>
                    </div>
                </div>
            </div>

            <!-- Input Area -->
            <div id="input-area">
                <div class="input-wrapper">
                    <textarea id="message-input" placeholder="Type a message..." rows="1"></textarea>
                    <button id="send-btn">Send</button>
                </div>
                <div class="action-buttons">
                    <button id="gen-image-btn" class="action-btn">üì∏ Image</button>
                    <button id="gen-image-direct-btn" class="action-btn">üéØ Direct</button>
                    <select id="image-model-select" class="model-select">
                        <option value="z-image-turbo" selected>Z-Image Turbo</option>
                        <option value="xl-lustify">XL Lustify</option>
                        <option value="xl-epicrealism">XL EpicRealism</option>
                        <option value="biglove-insta">BigLove Insta</option>
                        <option value="mohawk-v20">MOHAWK v20</option>
                        <option value="colossus-xl">Colossus XL</option>
                        <option value="juggernaut-xl">Juggernaut XL</option>
                        <option value="pikon-realism">Pikon Realism</option>
                        <option value="realistic-stock">Realistic Stock</option>
                        <option value="unstable-illusion">Unstable Illusion</option>
                        <option value="unstable-illusion-v2">Unstable Illusion V2</option>
                    </select>
                    <select id="video-model-select" class="video-select">
                        <option value="wan">WAN S2V</option>
                        <option value="infinitetalk">InfiniteTalk</option>
                        <option value="infinitetalk-fast">InfiniteTalk Fast</option>
                        <option value="hunyuan-avatar">Hunyuan Avatar</option>
                    </select>
                    <button id="gen-video-btn" class="action-btn">üé• Generate</button>
                    <button id="lora-video-btn" class="action-btn">üé¨ WAN</button>
                    <button id="script-tts-btn" class="action-btn">üé§ Script</button>
                    <select id="lipsync-model-select" class="model-select">
                        <option value="veed" selected>Veed (default)</option>
                        <option value="pixverse">Pixverse (express)</option>
                    </select>
                    <button id="lipsync-btn" class="action-btn">üéôÔ∏è Lipsync</button>
                </div>
            </div>
        </div>

        <!-- Sessions Browser Modal -->
        <div id="sessions-modal" class="modal hidden">
            <div class="modal-content">
                <h2>üìÇ Resume Session</h2>
                <div class="form-group">
                    <input type="text" id="session-search" placeholder="Search sessions...">
                </div>
                <div class="form-group">
                    <select id="session-character-filter">
                        <option value="">All Characters</option>
                    </select>
                </div>
                <div id="sessions-list" class="sessions-list">
                    <!-- Sessions will be populated by JS -->
                    <div class="loading">Loading sessions...</div>
                </div>
                <div class="modal-actions">
                    <button id="new-session-btn">‚ûï New Session</button>
                    <button id="close-sessions-btn">Close</button>
                </div>
            </div>
        </div>

        <!-- Password Modal -->
        <div id="password-modal" class="modal hidden">
            <div class="modal-content">
                <h2>Enter Password</h2>
                <div class="form-group">
                    <label for="remote-password">Remote Access Password:</label>
                    <input type="password" id="remote-password" placeholder="Enter password">
                </div>
                <div class="modal-actions">
                    <button id="submit-password-btn">Submit</button>
                </div>
            </div>
        </div>

        <!-- Settings Modal -->
        <div id="settings-modal" class="modal hidden">
            <div class="modal-content">
                <h2>Settings</h2>
                <div class="form-group">
                    <label>System Prompt</label>
                    <textarea id="system-prompt"></textarea>
                </div>
                <div class="form-group">
                    <label>Image Prompt</label>
                    <textarea id="image-prompt"></textarea>
                </div>
                <div class="form-group">
                    <label>TTS URL</label>
                    <input type="text" id="tts-url">
                </div>
                <div class="form-group checkbox-group">
                    <input type="checkbox" id="read-narration">
                    <label for="read-narration">Read Narration (TTS)</label>
                </div>
                <div class="form-group checkbox-group">
                    <input type="checkbox" id="pov-mode">
                    <label for="pov-mode">POV Image Mode</label>
                </div>
                <div class="form-group checkbox-group">
                    <input type="checkbox" id="first-person-mode">
                    <label for="first-person-mode">First-Person Mode (No Face Swap)</label>
                </div>
                <div class="modal-actions">
                    <button id="save-settings-btn">Save</button>
                    <button id="close-settings-btn">Close</button>
                </div>
            </div>
        </div>

        <!-- LoRA Video Modal -->
        <div id="lora-modal" class="modal hidden">
            <div class="modal-content">
                <h2>WAN Video Generation</h2>
                <div class="form-group">
                    <label for="wan-model-select">Model</label>
                    <select id="wan-model-select">
                        <option value="wan-2.2-fast" selected>WAN 2.2 Fast (HuggingFace)</option>
                        <option value="wan-2.1-lora">WAN 2.1 (CivitAI)</option>
                    </select>
                </div>

                <!-- LoRA Selection with Categories -->
                <div class="form-group">
                    <label>‚≠ê Favorites</label>
                    <div id="lora-favorites" class="lora-grid"
                        style="display: flex; flex-wrap: wrap; gap: 6px; min-height: 30px; padding: 8px; background: rgba(255,255,255,0.05); border-radius: 6px; margin-bottom: 10px;">
                        <!-- Populated by JS -->
                    </div>
                </div>

                <div class="form-group">
                    <label>Category</label>
                    <div id="lora-categories" style="display: flex; flex-wrap: wrap; gap: 6px; margin-bottom: 10px;">
                        <button type="button" class="lora-cat-btn active" data-cat="all">All</button>
                        <button type="button" class="lora-cat-btn" data-cat="expressions">Expr</button>
                        <button type="button" class="lora-cat-btn" data-cat="dance">Dance</button>
                        <button type="button" class="lora-cat-btn" data-cat="foreplay">Foreplay</button>
                        <button type="button" class="lora-cat-btn" data-cat="oral">Oral</button>
                        <button type="button" class="lora-cat-btn" data-cat="positions">Positions</button>
                        <button type="button" class="lora-cat-btn" data-cat="climax">Climax</button>
                        <button type="button" class="lora-cat-btn" data-cat="effects">Effects</button>
                    </div>
                </div>

                <div class="form-group">
                    <label>LoRA 1 (optional) <span id="selected-lora-name" style="color: #0ea5e9;"></span></label>
                    <div id="lora-grid" class="lora-grid"
                        style="display: flex; flex-wrap: wrap; gap: 6px; max-height: 150px; overflow-y: auto; padding: 8px; background: rgba(255,255,255,0.05); border-radius: 6px;">
                        <!-- Populated by JS -->
                    </div>
                    <input type="hidden" id="lora-preset-select" value="">
                </div>

                <div class="form-group" id="custom-url-group" style="display:none;">
                    <label for="lora-url">Custom LoRA 1 URL</label>
                    <input type="text" id="lora-url" placeholder="HuggingFace or CivitAI URL...">
                </div>
                <div class="form-group">
                    <label for="lora-prompt">Prompt</label>
                    <textarea id="lora-prompt" placeholder="Describe the video motion/action..."></textarea>
                </div>
                <div class="form-group">
                    <label for="lora-scale">LoRA 1 Scale</label>
                    <input type="number" id="lora-scale" value="1" min="0" max="2" step="0.1">
                </div>

                <!-- LoRA 2 (simplified - just dropdown for now) -->
                <div class="form-group">
                    <label for="lora-preset-select-2">LoRA 2 (optional)</label>
                    <select id="lora-preset-select-2">
                        <option value="none">None</option>
                    </select>
                </div>
                <div class="form-group" id="custom-url-group-2" style="display:none;">
                    <label for="lora-url-2">Custom LoRA 2 URL</label>
                    <input type="text" id="lora-url-2" placeholder="HuggingFace or CivitAI URL...">
                </div>
                <div class="form-group" id="lora-scale-2-group" style="display:none;">
                    <label for="lora-scale-2">LoRA 2 Scale</label>
                    <input type="number" id="lora-scale-2" value="1" min="0" max="2" step="0.1">
                </div>
                <div class="form-group">
                    <label for="lora-frames">Frames (81-121)</label>
                    <input type="number" id="lora-frames" value="81" min="81" max="121" step="1">
                </div>
                <div class="form-group">
                    <label for="lora-fps">FPS (5-30)</label>
                    <input type="number" id="lora-fps" value="16" min="5" max="30" step="1">
                </div>

                <!-- Debug Mode Section -->
                <div class="form-group"
                    style="border-top: 1px solid rgba(255,255,255,0.2); padding-top: 15px; margin-top: 15px;">
                    <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                        <input type="checkbox" id="debug-mode-toggle">
                        <span>üîß Debug Mode (Build Image Prompt)</span>
                    </label>
                </div>

                <div id="debug-mode-section" style="display: none;">
                    <!-- Image Preview -->
                    <div id="debug-preview-container" style="display: none; margin-bottom: 15px; text-align: center;">
                        <img id="debug-preview-image" style="max-width: 100%; max-height: 300px; border-radius: 8px;">
                    </div>

                    <!-- Component Dropdowns -->
                    <div class="form-group">
                        <label for="prompt-character">Character</label>
                        <select id="prompt-character">
                            <option value="">-- Select --</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="prompt-pose">Pose</label>
                        <select id="prompt-pose">
                            <option value="">-- Select --</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="prompt-setting">Setting</label>
                        <select id="prompt-setting">
                            <option value="">-- Select --</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="prompt-style">Style</label>
                        <select id="prompt-style">
                            <option value="">-- Select --</option>
                        </select>
                    </div>

                    <!-- Built Prompt (Editable) -->
                    <div class="form-group">
                        <label for="debug-image-prompt">Image Prompt (editable)</label>
                        <textarea id="debug-image-prompt" rows="3"
                            placeholder="Built prompt will appear here..."></textarea>
                    </div>

                    <div style="display: flex; gap: 10px; margin-bottom: 15px;">
                        <button type="button" id="generate-preview-btn" style="flex: 1;">üì∑ Generate Preview</button>
                        <button type="button" id="use-chat-prompt-btn" style="flex: 0;">üìù From Chat</button>
                    </div>
                </div>

                <div class="modal-actions">
                    <button id="generate-lora-btn">Generate</button>
                    <button id="sync-loras-btn">üì• Sync to Local</button>
                    <button id="close-lora-btn">Close</button>
                </div>
            </div>
        </div>

        <!-- Script TTS Modal -->
        <div id="script-tts-modal" class="modal hidden">
            <div class="modal-content">
                <h2>üé§ Script TTS</h2>
                <div class="form-group">
                    <label for="tts-script-input">Enter script for character to speak:</label>
                    <textarea id="tts-script-input" rows="4"
                        placeholder="Type what you want the character to say..."></textarea>
                </div>
                <div class="modal-actions">
                    <button id="generate-script-tts-btn">üîä Generate</button>
                    <button id="close-script-tts-btn">Close</button>
                </div>
            </div>
        </div>
    </div>
    <script src="app.js"></script>
</body>

</html>